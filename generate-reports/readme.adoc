:toc: left
:imagesdir: includes
= Generate Reports About Structures and Metrics
Dirk Mahler <dirk.mahler@jqassistant.org>

:numbered:

[.lead]
// tag::lead[]
This tutorial is about generating descriptive reports from your jqassistant-report.xml. This file gets produced by jQAssistant when building your project using jQAssistant. You can render full on documents including rules with their embedded result tables, diagrams or CSV files.
// end::lead[]

NOTE: This tutorial is written for version 2.0.4 of jQAssistant.

== Overview

Rules (i.e. concepts, constraints and groups) are written in xml files. When executing, jQAssistant produces a jqassistant-report.xml file is produced which reflects the analysis results. You can then use Asciidoctorj in combination with the `jqassistant-asciidoctorj-extensions` plugin to transform this xml file to readable html, pdf, confluence or any other file type supported by Asciidoctorj.

=== Report type options

When writing the rules, you have the option to specify different report types to visualize the results of your rules. These are:

`<<component-diagrams,plantuml-component-diagram>>`::
  Nodes and relationships of the result are converted to a PlantUML component diagram and rendered to an SVG file.
`<<class-diagrams,plantuml-class-diagram>>`::
  Nodes representing Java packages, classes, fields or members and their connecting relations are converted
  to a PlantUML class diagram which is rendered to an SVG file.
`<<sequence-diagrams,plantuml-sequence-diagram>>`::
  Path structures of the result are converted to a PlantUML sequence diagrams which is rendered to an SVG file.

Furthermore a report type may be chosen for creating a file of a dedicated format which then will be shown as link:

`<<graphml,graphml>>`::
  Similar to the `plantuml-component-diagram` nodes and relationships are converted to a GraphML file.
  This may be viewed and explored using http://www.yworks.com/en/products/yfiles/yed/[yEd].
`csv`::
  Create a CSV file containing tabular data for further analysis in other tools. There is no section about this type in the tutorial, but it is generally very similar to the example in the <<Tables>> section (the only difference being, that the results are put into a csv).

WARNING: For some of these export types, you may need some extra plugins. Refer to the <<Adding jQAssistant plugins>> section for details.

=== Result rendering

When writing your documentation, you have the option to use the following include directives:

`<<Rendering summaries, include::jQAssistant:Summary[]>>`::
renders a summary table with the rules from the project.

`<<Rendering rules, include::jQAssistant:Rules[]>>`::
renders the rules from the project with detailed information for each rule.

=== Project structure

For this tutorial the following project structure is going to be used:

[source,raw]
----
your.project      <1>
your.project.a    <2>
your.project.b
your.project.c
----

<1> The root package of the project is `your.project`.
<2> A package located directly within the root package represents a `Module`.
The project consists of the modules `a`, `b` and `c` where `b` and `c` contain Java types depending on types located in `a`.

== Integrate required dependencies into the project

The tutorial uses https://maven.apache.org[Apache Maven] for building the project.

=== Adding jQAssistant

jQAssistant is enabled by adding the plugin to the build/plugins section of the file `pom.xml`:

[source,xml]
.pom.xml enabling jQAssistant
----
include::pom.xml[tag=jQAplugin,indent=0]
----

=== Adding Asciidoctor

To render the reports as readable files we need to implement Asciidoctor into our project. In our example we use the `asciidoctor-maven-plugin`. We also need to add the `jqassistant-asciidoctorj-extensions` to Asciidoctor. This is needed later to process and include the results generated by jQAssistant. The following snippet also stems from the build/plugins part of the pom.xml:

[source,xml]
.pom.xml enabling Asciidoctor
----
include::pom.xml[tag=Asciidocplugin,indent=0]
----
<1> defines the file type for our reports
<2> defines that Asciidoctor preserves the folder structure we created inside our `src/docs/asciidoc` directory
<3> defines where jQAssistant puts the jqassistant-report.xml (jQAssistant normally puts the file always in this location; if you want to process another `jqassistant-report.xml` you have lying around somewhere, you can change this attribute)
<4> defines where the `jqassistant-asciidoctorj-extensions` copies the images referenced by the `jqassistant-report.xml` to (the path is relative to the export path)
<5> includes the aforementioned `jqassistant-asciidoctorj-extensions` into the Asciidoctor chain

TIP: If you want to know more about the `asciidoctor-maven-plugin` and the available configuration attributes check the https://github.com/asciidoctor/asciidoctor-maven-plugin#examples[Github page] for some helpful examples.

=== Adding jQAssistant plugins

To render your reports as diagrams or graphs you need to add some plugins to jQAssistant. Also you need to add the :

[source, yaml]
.jqassistant.yml
....
include::.jqassistant.yml[]
....
<1> This plugin is needed to use the report types `plantuml-component-diagram`, `plantuml-class-diagram` and `plantuml-sequence-diagram`
<2> This plugin is needed to use the report type graphml
<3> This line tells jQAssistant to apply the group (groups are rules just like concepts and constraints) `Default`, which is defined in default.xml.

TIP: To verify the setup, a build can be triggered using `mvn verify`.
The build should succeed and show a console output containing jQAssistant's scan and analysis messages.

== Writing rules

=== Where are the rules located?

All rules are written as xml file which are located in the folder `jqassistant/`:

[source,raw]
-----
jqassistant/default.xml    <1>
jqassistant/module.xml     <2>
-----
<1> link:jqassistant/default.xml[default.xml]: This file defines a top level group that (recursively) includes the rules from module.xml
<2> link:jqassistant/module.xml[module.xml]: This file defines rules that generate reports about the project's module structure as tables, diagrams and GraphML files.

=== Rule-report types

In the following sections the different report types for rules will be explained. The rules are processed by jQAssistant and the reports are be placed inside the `jqassistant-report.xml` (in case of rendered diagrams or attachments, the files are placed inside the `target/jqassistant/report` directory and are only referenced in the `jqassistant-report.xml`).

In the following sections, all depicted pictures are generated by applying the steps from <<Rendering reports>>.

==== Tables

The file `module.xml` defines concepts related to the module structure of the project and for generating reports in different representations.

A concept `module:Module` first adds a label `Module` to each child package of the root package `your.project`:

[source,xml]
....
include::jqassistant/module.xml[tags=moduleModule]
....

The returned result defines two columns `Module` (the name of the module) and `Package`.
As no report type is specified for this concept its result would be rendered to a table containing these columns:

image::module_table.png[Resultset]

NOTE: The table is not saved as a file. Instead, this tables structure is stored directly in the xml. To render it to a readable format, check the <<Rendering reports>> section.

[[component-diagrams]]
==== Component Diagrams
The concept `module:Dependencies` which is based on `module:Module` aggregates the type dependencies to the module packages:

[source,xml]
....
include::jqassistant/module.xml[tags=moduleDependencies]
....

This concept returns the modules (module1, module2) and their dependency relations (dependsOn).
The result is used for generating a component diagram by setting the `reportType` attribute to `plantuml-component-diagram`.

image::module_component_diagram.png[]

TIP: The generated .plantuml and .svg files are located in the folder `target/jqassistant/report/plantuml`.

[[graphml]]
==== GraphML Files

If diagrams become more complex it may be useful to export them as GraphML documents:

[source,xml]
....
include::jqassistant/module.xml[tags=moduleDependenciesGraphML]
....

To render a graphml we are setting the `report type` to `graphml` as illustrated above.

The HTML document will provide a link to the GraphML file:

image::module_graphml_report_link.png[Resultset]

TIP: The generated .graphml files are located in the folder `target/jqassistant/report/graphml`.
They may be viewed using http://www.yworks.com/en/products/yfiles/yed/[yEd].
After opening a file you need to apply a layout, Layout->Hierarchical (Alt-Shift-H).

//image::module_graphml_yed.png[]

By extending the result structure the GraphML reports may be used to allow an interactive drill-down from module to type level:

[source,xml]
....
include::jqassistant/module.xml[tags=moduleDependenciesGraphMLDrilldown]
....

This concept returns a graph for each module which is rendered as `parent` containing types (`nodes`) and dependencies (`relationships`) per module.
The generated GraphML report file can be interactively explored in yEd by expanding (`+`) or collapsing (`-`) module nodes and applying the horizontal layout:

//image::module_graphml_drilldown_yed.png[]

[[class-diagrams]]
==== Class Diagrams

Java structures returned by a rule may be rendered to class diagrams.
The following elements are supported:

* Packages (`:Java:Package`)
* Types (`:Java:Type`)
* Members (`:Java:Member`, `:Java:Field`, `:Java:Method`)
* Inheritance relations between types (`:EXTENDS`, `:IMPLEMENTS`)
* any other relations between types (rendered as associations)

The concept `module:ClassDiagram` returns all types including their optional fields and methods:

[source,xml]
....
include::jqassistant/module.xml[tags=moduleClassDiagram]
....

As the report type is set to `plantuml-class-diagram`, the following diagram is rendered:

image::module_class_diagram.png[]

[[sequence-diagrams]]
==== Sequence Diagrams

The concept `module:SequenceDiagram` returns a path structure with a column named `sequence`. When there is such a column, the report can be rendered as a sequence diagram:

[source,xml]
....
include::jqassistant/module.xml[tags=moduleSequenceDiagram]
....

As the report type is set to `plantuml-sequence-diagram`, the following diagram is rendered:

image::module_sequence_diagram.png[]


In this diagram the nodes of the sequence are interpreted as participants and the relationships between them as messages.

== Rendering reports

In this tutorial there are two files that will be rendered by Asciidoctor. The sources of both files are located in the `src/docs/asciidoc/modules` directory. This is the default location the `asciidoctor-maven-plugin` looks for files to render in. The rendered files are then stored in the `target/generated-docs` directory (also the default).

TIP: Check the https://github.com/asciidoctor/asciidoctor-maven-plugin[asciidoctor-maven-plugin Github page] for more information on how to change these default values.

In our example the link:src/docs/asciidoc/index.adoc[index.adoc] represents the root file. It includes the link:src/docs/asciidoc/modules/module.adoc[module.adoc] with the following line:

....
\include::modules/module.adoc[leveloffset=+1]
....

TIP: The `leveloffset` attribute is responsible for offsetting each heading from the link:src/docs/asciidoc/modules/module.adoc[module.adoc] by the given number. Refer to https://docs.asciidoctor.org/asciidoc/latest/directives/include/#include-syntax[include directive Asciidoctor]

=== Rendering summaries

To render a summary of our jQAssistant reports within an adoc file, we use:

[source,adoc]
....
\include::jQAssistant:Summary[]
....

This syntax is used in the link:src/docs/asciidoc/index.adoc[index.adoc].

NOTE: The summary table will be displayed in the index.html inside the `target/generated-docs` directory after you executed your maven build (`mvn verify`).

=== Rendering rules

To render a rules with their respective results within an adoc file, we use:

[source,adoc]
....
\include::jQAssistant:Rules[]
....

This syntax is used in the link:src/docs/asciidoc/modules/module.adoc[module.adoc].

TIP: The `concepts="module:Module"` attribute describes a way of filtering the displayed rules. You can use `concepts` and `constraints` attributes to specify the rules that are displayed (this also works for the summary). There is also the possibility to use wildcards (*) in these filters. Refer to the https://github.com/jqassistant-tooling/jqassistant-asciidoctorj-extensions#create-your-report[jqassistant-asciidoctorj-extensions readme] for more information.

== Resources

1. https://maven.apache.org[Apache Maven]
2. https://jqassistant.github.io/jqassistant/doc/2.0.0/manual[jQAssistant manual]
3. https://github.com/asciidoctor/asciidoctor-maven-plugin[asciidoctor-maven-plugin]
4. https://github.com/jqassistant-tooling/jqassistant-asciidoctorj-extensions[jqassistant-asciidoctorj-extensions]
5. http://www.yworks.com/en/products/yfiles/yed/[yEd]



